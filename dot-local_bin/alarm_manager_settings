#!/bin/bash

# Path Definitions
DISMISS_CONF="$HOME/.config/alarm-early-dismissal.conf"
VOL_CONF="$HOME/.config/alarm-volume-manager.conf"

# 1. Load current values or set defaults
[ -f "$DISMISS_CONF" ] && source "$DISMISS_CONF"
[ -f "$VOL_CONF" ] && source "$VOL_CONF"

# 2. Show an Editable List
# This acts like a mini-spreadsheet of your settings
OUTPUT=$(zenity --list --title="Master Alarm Settings" \
    --text="Double-click a value to edit it, then click OK to save." \
    --column="Setting" --column="Value" --editable \
    "Dismissal Minutes" "${EARLY_DISMISSAL_WINDOW:-15}" \
    "Volume Start (%)" "${ALARM_MIN:-5}" \
    "Volume Max (%)" "${ALARM_MAX:-90}" \
    "Volume Step" "${STEP:-2}" \
    "Ramp Interval (sec)" "${INTERVAL:-1}")

# 3. Parse the output
# Zenity --list returns a single column by default (the first one) 
# unless we use specific flags, but we can grab it all via a trick.

if [ $? -eq 0 ]; then
    # We re-run the logic to pull the values based on their label
    # because zenity --list --editable returns the *edited* line.
    
    D_VAL=$(echo "$OUTPUT" | grep "Dismissal Minutes" | cut -d'|' -f2)
    V_MIN=$(echo "$OUTPUT" | grep "Volume Start" | cut -d'|' -f2)
    V_MAX=$(echo "$OUTPUT" | grep "Volume Max" | cut -d'|' -f2)
    V_STEP=$(echo "$OUTPUT" | grep "Volume Step" | cut -d'|' -f2)
    V_INT=$(echo "$OUTPUT" | grep "Ramp Interval" | cut -d'|' -f2)

    # Save logic
    echo "EARLY_DISMISSAL_WINDOW=${D_VAL:-15}" > "$DISMISS_CONF"
    cat <<EOF > "$VOL_CONF"
VOL_MAN_ENABLED=1
ALARM_MIN=${V_MIN:-5}
ALARM_MAX=${V_MAX:-90}
STEP=${V_STEP:-2}
INTERVAL=${V_INT:-1}
EOF
fi
